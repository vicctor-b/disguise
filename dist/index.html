<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Quiz de Monstros - Ragnarok</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden; /* Evita scroll horizontal */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .main-container {
      display: flex;
      gap: 20px;
      max-width: 1260px;
      width: 100%;
      align-items: start;
      justify-content: center;
      margin: 0 auto;
    }

    .scoreboard-panel {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 300px;
      min-width: 300px;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      height: 80vh;
      max-height: 80vh;
    }

    .scoreboard-panel h3 {
      color: #ffd700;
      text-align: center;
      margin: 0 0 20px 0;
      font-size: 1.2em;
    }

    .scoreboard-content {
      flex: 1;
      overflow-y: auto;
    }

    .score-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .score-item .player-name {
      font-weight: bold;
      color: #fff;
    }

    .score-item .score {
      background: rgba(255, 215, 0, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      color: #ffd700;
      font-weight: bold;
    }

    .score-item.no-scores {
      justify-content: center;
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 500px;
      min-width: 500px;
      max-width: 500px;
      text-align: center;
      height: 80vh;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .history-panel {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 400px;
      min-width: 400px;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 80vh;
      max-height: 80vh;
    }
    
    .history-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 5px;
      min-height: 0; /* Permite que o flex funcione corretamente */
      max-height: calc(80vh - 100px); /* Altura máxima menos espaço para título e padding */
    }
    
    .history-panel h3 {
      color: #ffd700;
      text-align: center;
      margin: 0 0 20px 0;
      font-size: 1.2em;
      flex-shrink: 0; /* Evita que o título seja comprimido */
    }
    
    .history-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .history-item.correct {
      border-left-color: #4ade80;
    }
    
    .history-item.incorrect {
      border-left-color: #f87171;
    }
    
    .history-item.timeout {
      border-left-color: #ffd700;
    }
    
    .history-item.reveal {
      border-left-color: #6366f1;
    }
    
    .history-item img {
      border-radius: 10px;
      margin: 0 auto 15px auto;
      display: block;
    }
    
    .history-item .monster-name {
      font-weight: bold;
      color: #fff;
      margin-bottom: 8px;
      font-size: 16px;
      word-break: break-word;
      text-align: center;
    }
    
    .history-item .result {
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .history-item .result-text {
      font-weight: bold;
      text-align: center;
    }

    .history-item .timestamp {
      font-size: 12px;
      opacity: 0.8;
      font-family: monospace;
    }

    .history-item .solver {
      font-weight: bold;
      text-decoration: underline;
    }
    
    .history-item.correct .result {
      color: #4ade80;
    }
    
    .history-item.incorrect .result {
      color: #f87171;
    }
    
    .history-item.timeout .result {
      color: #ffd700;
    }
    
    .history-item.reveal .result {
      color: #6366f1;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .main-container {
        flex-direction: column;
        align-items: center;
        max-width: 100%;
      }
      
      .container {
        width: 100%;
        min-width: auto;
        max-width: 500px;
        order: 1;
      }
      
      .history-panel {
        width: 100%;
        min-width: auto;
        max-width: 500px;
        order: 2;
        margin-top: 20px;
        height: 60vh;
        max-height: 60vh;
      }
    }
    
    h1 {
      font-size: 2em;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      background: linear-gradient(45deg, #ffd700, #ff6b35);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      flex-shrink: 0;
    }
    
    .image-container {
      position: relative;
      margin: 15px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 150px;
      flex-shrink: 0;
    }

    .image-container img {
      transform: scale(1.5);
    }
    
    img {
      max-width: 150px;
      max-height: 150px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    img:hover {
      transform: scale(1.55);
    }
    
    .loading {
      display: none;
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .input-container {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    
    input {
      padding: 15px 20px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      outline: none;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    input:focus {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      background: rgba(255, 255, 255, 1);
    }
    
    input:disabled {
      background: rgba(150, 150, 150, 0.3);
      color: #888;
      cursor: not-allowed;
      transform: none;
    }
    
    button {
      padding: 15px 25px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      background: linear-gradient(45deg, #ff6b35, #f7931e);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      background: linear-gradient(45deg, #f7931e, #ff6b35);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: rgba(150, 150, 150, 0.5);
      cursor: not-allowed;
      transform: none;
      opacity: 0.6;
    }
    
    button:disabled:hover {
      background: rgba(150, 150, 150, 0.5);
      transform: none;
    }
    
    .reveal-btn {
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      padding: 15px 20px;
      font-size: 14px;
    }
    
    .reveal-btn:hover {
      background: linear-gradient(45deg, #8b5cf6, #6366f1);
    }
    
    .answer {
      font-size: 16px;
      font-weight: bold;
      margin: 15px 0;
      padding: 12px;
      border-radius: 15px;
      background: transparent;
      min-height: 45px;
      max-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      text-align: center;
      line-height: 1.2;
      flex-shrink: 0;
    }
    
    .answer.has-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
    }
    
    .answer.correct {
      color: #4ade80;
      border: 2px solid #4ade80;
    }
    
    .answer.incorrect {
      color: #f87171;
      border: 2px solid #f87171;
    }
    
    .answer.reveal {
      color: #ffd700;
      border: 2px solid #ffd700;
    }
    
    .timer {
      font-size: 20px;
      font-weight: bold;
      color: #ffd700;
      margin: 15px 0;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      border: 2px solid #ffd700;
      text-shadow: 0 0 10px #ffd700;
      flex-shrink: 0;
    }
    
    .timer.warning {
      color: #ff6b35;
      border-color: #ff6b35;
      text-shadow: 0 0 10px #ff6b35;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .attempts {
      margin-top: 15px;
      text-align: left;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 12px;
      max-height: 520px;
      min-height: 40px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0;
    }
    
    .attempts h3 {
      margin: 0 0 10px 0;
      color: #ffd700;
      text-align: center;
    }
    
    .attempt {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .attempt.success {
      background: rgba(74, 222, 128, 0.2);
      border-left: 4px solid #4ade80;
      color: #4ade80;
    }

    .attempt.failure {
      background: rgba(248, 113, 113, 0.2);
      border-left: 4px solid #f87171;
      color: #f87171;
    }

    .attempt.ignored {
      background: rgba(148, 163, 184, 0.2);
      border-left: 4px solid #94a3b8;
      color: #94a3b8;
      opacity: 0.7;
      font-style: italic;
    }

    .attempt .player-name {
      font-weight: bold;
    }

    .attempt.ignored .player-name {
      color: #94a3b8;
    }

    .attempt.success .player-name {
      color: #6ee7a0;
    }

    .attempt.failure .player-name {
      color: #ff8787;
    }

    .attempt .attempt-time {
      margin-left: auto;
      opacity: 0.7;
      font-family: monospace;
      font-size: 12px;
    }
    
    .attempts::-webkit-scrollbar {
      width: 6px;
    }
    
    .attempts::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .attempts::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }
    
    .history-panel::-webkit-scrollbar {
      width: 0; /* Remove o scroll do painel principal */
    }
    
    .history-panel::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .history-panel::-webkit-scrollbar-thumb {
      background: transparent;
    }
    
    .history-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .history-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .history-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    /* Modal de conexão */
    .connection-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .connection-modal.visible {
      display: flex;
    }

    .connection-modal .status {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px 40px;
      border-radius: 15px;
      font-size: 1.2em;
      font-weight: bold;
      color: #ffd700;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .connection-modal .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 215, 0, 0.3);
      border-top: 3px solid #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .connection-modal .message {
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      max-width: 400px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="connection-modal visible" id="connectionModal">
    <div class="status">
      <div class="spinner"></div>
      <span>Reconectando...</span>
    </div>
    <div class="message">
      Perdemos a conexão com o servidor. Tentando reconectar automaticamente...
      <br>
      Se o problema persistir, tente recarregar a página.
    </div>
  </div>

  <div class="main-container">
    <div class="scoreboard-panel">
      <h3>🏆 Placar</h3>
      <div class="scoreboard-content" id="scoreboard">
      </div>
    </div>
    <div class="container">
      <h1>Qual é o monstro?</h1>
      
      <div class="answer" id="answer"></div>
      
      <div class="image-container">
        <div class="loading" id="loading"></div>
        <img id="monster-img" src="https://vitcunha.s3.sa-east-1.amazonaws.com/ragnadb/gifs/1639.gif" alt="Monstro" style="display: none;">
      </div>
      
      <div class="input-container">
        <input type="text" id="guess" placeholder="Digite o nome do monstro" autocomplete="off">
        <button onclick="checkAnswer()">Enviar</button>
      </div>
      
      <div class="timer" id="timer">Tempo restante: 20</div>
      
      <div class="attempts" id="attempts" style="display: none;">
        <h3>📝 Tentativas:</h3>
        <div id="attempts-list"></div>
      </div>
    </div>
    
    <div class="history-panel">
      <h3>📚 Histórico de Monstros</h3>
      <div class="history-content">
        <div id="monster-history"></div>
      </div>
    </div>
  </div>

  <script>
    // Get player name from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get('name');

    // Configurações do WebSocket
    const wsProtocol = window.location.hostname === '' ? 'ws:' : 'wss:';
    const wsHost = window.location.hostname === '' ? 'localhost:3000' : "disguise.onrender.com";
    const wsUrl = `${wsProtocol}//${wsHost}?name=${encodeURIComponent(playerName)}`;
    
    let socket = null;
    let reconnectAttempts = 0;
    let reconnectInterval = null;
    const maxReconnectAttempts = 5;
    const baseReconnectDelay = 1000; // 1 segundo
    let isConnected = false;

    function showConnectionModal(show) {
      document.getElementById('connectionModal').classList.toggle('visible', show);
    }

    function scheduleReconnect() {
      if (reconnectInterval) return; // Já está tentando reconectar

      if (reconnectAttempts >= maxReconnectAttempts) {
        console.log('Número máximo de tentativas de reconexão atingido');
        return;
      }

      const delay = Math.min(baseReconnectDelay * Math.pow(2, reconnectAttempts), 10000);
      console.log(`Tentando reconectar em ${delay}ms (tentativa ${reconnectAttempts + 1}/${maxReconnectAttempts})`);
      
      reconnectInterval = setTimeout(() => {
        reconnectAttempts++;
        connect();
        reconnectInterval = null;
      }, delay);
    }

    function connect() {
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        return; // Já está conectado ou conectando
      }

      socket = new WebSocket(wsUrl);

      socket.onopen = function() {
        console.log('WebSocket conectado');
        isConnected = true;
        reconnectAttempts = 0;
        showConnectionModal(false);
        clearInterval(reconnectInterval);
      };

      socket.onclose = function() {
        console.log('WebSocket desconectado');
        isConnected = false;
        showConnectionModal(true);
        scheduleReconnect();
      };

      socket.onerror = function(error) {
        console.error('Erro no WebSocket:', error);
        isConnected = false;
      };

        socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      
      if (data.type === 'gameStatus') {
        // Update scoreboard
        const scoreboardContent = document.getElementById('scoreboard');
        if (scoreboardContent) {  // Check if element exists
          if (Array.isArray(data.scoreboard) && data.scoreboard.length > 0) {
            scoreboardContent.innerHTML = data.scoreboard
              .sort((a, b) => b[1] - a[1])
              .map(([player, score]) => `
                <div class="score-item">
                  <span class="player-name">${player}</span>
                  <span class="score">${score}</span>
                </div>
              `).join('');
          } else {
            scoreboardContent.innerHTML = `
              <div class="score-item no-scores">
                <span>Nenhuma pontuação ainda</span>
              </div>
            `;
          }
        }

        // Update monster image
        const monsterImg = document.getElementById('monster-img');
        monsterImg.src = `https://vitcunha.s3.sa-east-1.amazonaws.com/ragnadb/gifs/${data.currentMob.id}.gif`;
        monsterImg.style.display = 'block';
        document.getElementById('loading').style.display = 'none';

        // Update history content
        const historyContent = document.getElementById('monster-history');
        historyContent.innerHTML = [...data.mobHistory].reverse().map(mob => {
          const statusClass = mob.status === 'solved' ? 'correct' : 
                            mob.status === 'timeout' ? 'timeout' : 'reveal';
          
          // Format the duration with 2 decimal places
          const duration = ((mob.endTime - mob.startTime) / 1000).toFixed(2); // Convert to seconds with decimals
          const formattedTime = new Date(mob.endTime).toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
          });

          // Format the result message based on status
          const resultText = mob.status === 'solved' ? 
            `<span class="solver">✨ ${mob.solverName}</span> acertou em ${duration}s` : 
            mob.status === 'timeout' ? 
            '⌛ Tempo Esgotado!' : 'Revelado';

          return `
            <div class="history-item ${statusClass}">
              <img src="https://vitcunha.s3.sa-east-1.amazonaws.com/ragnadb/gifs/${mob.mobId}.gif" alt="${mob.mobName}">
              <div class="monster-name">${mob.mobName}</div>
              <div class="result">
                <div class="result-text">${resultText}</div>
                <div class="timestamp">${formattedTime}</div>
              </div>
            </div>
          `;
        }).join('');

        // Update answer display
        const answerElement = document.getElementById('answer');
        if (data.currentMobSolved) {
          answerElement.textContent = `${data.solverName} acertou! Eu era "${data.currentMob.name}!"`;
          answerElement.className = 'answer has-content correct';
        } else {
          answerElement.textContent = '';
          answerElement.className = 'answer';
        }

        // Update timer
        const timerElement = document.getElementById('timer');
        timerElement.textContent = `Tempo restante: ${data.remainingTime}`;
        
        // Add warning class if time is running low (less than 5 seconds)
        timerElement.className = 'timer' + (data.remainingTime <= 5 ? ' warning' : '');

        // Update attempts list
        const attemptsContainer = document.getElementById('attempts');
        const attemptsList = document.getElementById('attempts-list');
        
        if (data.attempts.length >= 0) {
          attemptsContainer.style.display = 'block';
          attemptsList.innerHTML = [...data.attempts].reverse().map(attempt => {
            const formattedTime = new Date(attempt.timestamp).toLocaleTimeString('pt-BR', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            // Determina a classe com base no status da tentativa
            const getAttemptClass = (attempt) => {
              if (attempt.ignored) return 'ignored';
              return attempt.success ? 'success' : 'failure';
            };

            return `
              <div class="attempt ${getAttemptClass(attempt)}">
                <span class="player-name">${attempt.playerName}:</span> 
                "${attempt.attempt}"
                ${attempt.ignored ? ' (ignorado)' : ''} 
                <span class="attempt-time">${formattedTime}</span>
              </div>
            `;
          }).join('');
        }
      }
    };

    }

    // Reconectar quando a página ganhar foco
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !isConnected) {
        console.log('Página recuperou foco, tentando reconectar...');
        connect();
      }
    });

    // Iniciar conexão
    connect();

    function checkAnswer(){
    // Function to check answer
      const guessInput = document.getElementById('guess');
      const guess = guessInput.value.trim();
      
      if (guess) {
        // Send the guess to the server
        socket.send(guess);
        
        // Clear the input
        guessInput.value = '';
        
        // Return focus to input for next guess
        guessInput.focus();
      }
    }

    // Add enter key support for submitting guess
    document.getElementById('guess').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkAnswer();
      }
    });

    // If no name provided, redirect to login
    if (!playerName) {
      window.location.href = 'login.html';
    }

    // Iniciar primeira conexão
    connect();
  </script>
</body>
</html>
